
该方法的存在的问题:
1. 做的事情太多
2. 扩展性差，如果希望以html格式输出详单，无法修改或者需要重写一个htmlStatement()方法，这样带来的问题是造成大量代码重复
   可读性很差
3. 如果计费标准发生变化又该如何，你不得不同时修改htmlStatement()方法
4. 用户希望改变影片分类规则

### 重构 
#### 搬移金额计算
##### step1
将逻辑泥团`switch`抽取到方法`amountFor`
使用`Extract Method`
##### step2
修改`amountFor`方法变量，使其具有实际意义
同时修改多个变量 选中变量`a`，`shift+f6`

观察`accountFor()`，发现这个函数使用了来自`Rental`类的信息，去没有使用来自
`Customer`类的信息
函数应该放在它所使用的数据的所属对象内，所以`accountFor()`应该移到`Rental`类中
使用`Move Method`
##### step3
找出程序中对于旧函数的所有引用点，并修改它们，让它们改用新函数
这里是将`statement()`中的`accountFor`改为`each.getCharge`
#### step4
做完修改之后，下一步就是要去掉旧函数
有时候会保留旧函数，让它调用新函数。如果旧函数是一个`public`函数，我又不想修改其他类接口，
这便是一种有用的手法

下一件事是：`thisAmount`变的有点多余了，它接受`each.getCharge`的执行结果，然后就不再有任何改变
，所以可以运用`Replace Temp with Query` 把 `thisAmount`去掉

```java
for (Rental each : rentals) {
     double thisAmount = 0;
     thisAmount=each.getCharge();

     // add frequent renter points
     frequentRenterPoints++;
     // add bonus for a two day new release rental
     if(each.getMovie().getPriceCode() == Movie.NEW_RELEASE&&each.getDayRented() > 1) {
        frequentRenterPoints++;
     }
     // show figures for this rental
     result+="\t"+each.getMovie().getTitle()+"\t"+thisAmount+"\n";
     totalAmount+=thisAmount;
}
```
去掉后
```java
for (Rental each : rentals) {
    // add frequent renter points
    frequentRenterPoints++;
    // add bonus for a two day new release rental
    if (each.getMovie().getPriceCode() == Movie.NEW_RELEASE && each.getDayRented() > 1) {
        frequentRenterPoints++;
    }
    // show figures for this rental
    result += "\t" + each.getMovie().getTitle() + "\t" + each.getCharge() + "\n";
    totalAmount += each.getCharge();
}
```
#### 提炼常客计算积分
下一步要对常客积分计算做类似处理 积分的计算视影片种类而有不同，不过不像收费规则那么多变化。看起来似乎有理由把积分计算责任放在
`Rental`类上。首先需要对常客积分计算这部分运用`ExtracMethod`重构：
```java
public String statement() {
     double totalAmount = 0;
     int frequentRenterPoints = 0;
     String result = "Rental Record for " + getName() + "\n";
     for (Rental each : rentals) {
     // double thisAmount = 0;
     // step 1. 将逻辑泥团使用ExtractMethod 抽取到amountFor
     // thisAmount = each.getCharge();

     // add frequent renter points
     frequentRenterPoints += each.getFrequentRenterPoints();
     // show figures for this rental
     result += "\t" + each.getMovie().getTitle() + "\t" + each.getCharge() + "\n";
     totalAmount += each.getCharge();
     }

     // add foot lines
     result += "Amount owed is " + totalAmount + "\n";
     result += "You earned " + frequentRenterPoints + " frequent renter points";

     return result;
}

public class Rental {
    
   public int getFrequentRenterPoints() {
      if (getMovie().getPriceCode() == Movie.NEW_RELEASE && getDayRented() > 1) {
         return 2;
      } else {
         return 1;
      }
   }
}
```
#### 去除临时变量
利用`Customer`类的`getTotalChange()`取代`totalAmount`
```java
public String statement() {
     double totalAmount = 0;
     int frequentRenterPoints = 0;
     String result = "Rental Record for " + getName() + "\n";
     for (Rental each : rentals) {
         // double thisAmount = 0;
         // step 1. 将逻辑泥团使用ExtractMethod 抽取到amountFor
         // thisAmount = each.getCharge();

         // add frequent renter points
         frequentRenterPoints += each.getFrequentRenterPoints();
         // show figures for this rental
         result += "\t" + each.getMovie().getTitle() + "\t" + each.getCharge() + "\n";
         totalAmount += each.getCharge();
     }

     // add foot lines
     result += "Amount owed is " + getTotalCharge() + "\n";
     result += "You earned " + frequentRenterPoints + " frequent renter points";

     return result;
 }

 private double getTotalCharge() {
     double result = 0;
     for (Rental each : rentals) {
         result += each.getCharge();
     }
     return result;
 }
```
这并不是`Replace Temp with Query`最简单的情况。由于`totalAmount`在循环内部被赋值，我不得不把循环复制到查询函数中  
同样的方法处理`frequentRenterPoints` : 
#### 增加`htmlStatement()`
`From Template Method(345)` 深入重构
